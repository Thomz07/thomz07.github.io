<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Claude 4.5 • Puter.js Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root{--bg:#0b0c10;--panel:#17191f;--muted:#9aa0aa;--text:#e9edf2;--accent:#3a7afe;--border:#262a33}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:920px;margin:0 auto;padding:24px} header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:18px;margin:0} .auth{display:flex;align-items:center;gap:8px}
    .btn{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed} .user{font-size:12px;color:var(--muted)}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:14px;overflow:hidden}
    .chat{height:56vh;min-height:320px;overflow:auto;padding:16px;scroll-behavior:smooth}
    .row{display:flex;gap:10px;padding:10px 16px;border-top:1px solid var(--border)}
    textarea{flex:1;resize:vertical;min-height:42px;max-height:35vh;background:#0f1116;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
    .send{width:120px} .bubble{max-width:76ch;padding:10px 12px;border:1px solid var(--border);border-radius:12px;margin:8px 0;white-space:pre-wrap}
    .usermsg{background:#0f1116} .aimsg{background:#121521} .muted{color:var(--muted);font-size:12px} .model{font-size:12px;color:var(--muted);margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div><h1>Claude 4.5 Client <span class="model">model: claude-sonnet-4-5</span></h1></div>
      <div class="auth">
        <span id="user-info" class="user">Statut: inconnu</span>
        <button id="signin" class="btn">Se connecter</button>
        <button id="signout" class="btn" style="display:none">Se déconnecter</button>
      </div>
    </header>

    <div class="card">
      <div id="chat" class="chat"></div>
      <div class="row">
        <button id="clear" class="btn">Vider</button>
        <textarea id="input" placeholder="Pose ta question..."></textarea>
        <button id="send" class="btn send">Envoyer</button>
      </div>
    </div>
    <p class="muted" style="margin-top:10px">Astuce: si le bouton ne marche pas, désactive COOP/COEP et les bloqueurs de pop-up.</p>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const signinBtn = document.getElementById('signin');
    const signoutBtn = document.getElementById('signout');
    const userInfo = document.getElementById('user-info');
    let messages = [];

    function bubble(text, who) {
      const div = document.createElement('div');
      div.className = 'bubble ' + (who === 'user' ? 'usermsg' : 'aimsg');
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }

    function setAuthUI(signed, user) {
      if (signed) {
        userInfo.textContent = user?.username ? ('Connecté: ' + user.username) : 'Connecté';
        signinBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        sendBtn.disabled = false;
      } else {
        userInfo.textContent = 'Non connecté';
        signinBtn.style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        sendBtn.disabled = true;
      }
    }

    async function refreshAuth() {
      try {
        const signed = await puter.auth.isSignedIn();
        if (signed) {
          const u = await puter.auth.getUser();
          setAuthUI(true, u);
        } else {
          setAuthUI(false);
        }
      } catch {
        userInfo.textContent = 'Erreur statut auth';
      }
    }

    signinBtn.addEventListener('click', async () => {
      signinBtn.disabled = true;
      try {
        await puter.auth.signIn();
      } catch(e) {
        alert('Connexion impossible: ' + (e?.message || e));
      } finally {
        signinBtn.disabled = false;
        refreshAuth();
      }
    });

    signoutBtn.addEventListener('click', async () => {
      try { await puter.auth.signOut(); } finally { refreshAuth(); }
    });

    clearBtn.addEventListener('click', () => { chatEl.innerHTML=''; messages=[]; });

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      bubble(text, 'user');
      messages.push({ role: 'user', content: text });
      const ph = bubble('…', 'ai');
      sendBtn.disabled = true;
      try {
        const stream = await puter.ai.chat(messages, { model: 'claude-sonnet-4-5', stream: true, temperature: 0.7 });
        let acc = '';
        for await (const part of stream) {
          const piece = part?.text || '';
          acc += piece;
          ph.textContent = acc;
          chatEl.scrollTop = chatEl.scrollHeight;
        }
        messages.push({ role: 'assistant', content: acc });
      } catch (e) {
        ph.textContent = 'Erreur: ' + (e?.message || e);
        if ((e?.message || '').toLowerCase().includes('sign in')) userInfo.textContent = 'Veuillez vous connecter à Puter';
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

    (async function boot() {
      await refreshAuth();
      try {
        await puter.kv.get('___noop'); // déclenche l’auth implicite si nécessaire
        await refreshAuth();
      } catch {}
    })();
  </script>
</body>
</html>